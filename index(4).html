<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OxCal Simulation Model in JavaScript</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">OxCal Chronological Model Simulation</h1>
            <p class="mt-2 text-lg text-gray-600">Understanding how simulations help validate archaeological models.</p>
        </header>

        <!-- OxCal Model Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">1. The Archaeological Scenario & OxCal Code</h2>
            <p class="mb-4">Imagine an archaeological site with three sequential phases. We know **Phase 1** is the oldest, followed by **Phase 2**, and finally **Phase 3**. To test if a Bayesian model can correctly date this sequence, we first create a simulation with known, "true" dates.</p>
            
            <p class="mb-2 font-semibold">Our "True" Calendar Dates:</p>
            <ul class="list-disc list-inside mb-4 bg-gray-50 p-4 rounded-lg">
                <li><strong class="font-semibold">Phase 1:</strong> A sample from 750 BC.</li>
                <li><strong class="font-semibold">Phase 2:</strong> Two samples, one from 650 BC and one from 600 BC.</li>
                <li><strong class="font-semibold">Phase 3:</strong> A sample from 525 BC.</li>
            </ul>

            <p class="mb-4">This is the code we would write in OxCal to simulate this scenario. The `Simulate()` function generates an ideal C14 date from a known calendar year.</p>

            <div class="bg-gray-800 text-white p-4 rounded-lg font-mono text-sm overflow-x-auto">
                <pre><code>Plot()
{
 Sequence("Simulatie Voorbeeld Nederzetting")
 {
  Boundary("Start");

  Phase("Fase 1")
  {
   // Simulate a sample with a "true" date of 750 BC (-749)
   // and a standard error of 30 years.
   Simulate("Monster_1", -749, 30);
  };

  Phase("Fase 2")
  {
   Simulate("Monster_2", -649, 30);
   Simulate("Monster_3", -599, 30);
  };

  Phase("Fase 3")
  {
   Simulate("Monster_4", -524, 30);
  };

  Boundary("Einde");
 };
};</code></pre>
            </div>
        </div>

        <!-- JavaScript Simulation Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">2. Interactive JavaScript Simulation</h2>
            <p class="mb-4">This simulation mimics what OxCal does behind the scenes. It takes the "true" calendar dates and generates a set of simulated C14 measurements. A real conversion uses a complex calibration curve (like IntCal20), but for this demonstration, we'll use a simplified formula to simulate the process.</p>
            
            <p class="mb-6">Click the button below to generate a new set of simulated C14 measurements based on our known dates. Each click represents a new "lab measurement" with random error.</p>

            <div class="text-center">
                <button id="run-simulation-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Run Simulation
                </button>
            </div>

            <div id="results-container" class="mt-6 hidden">
                <h3 class="text-xl font-bold mb-4">Simulation Results:</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Phase</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sample Name</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">"True" Calendar Date</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Simulated C14 Age (BP)</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="divide-y divide-gray-200">
                            <!-- Results will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                 <p class="text-xs text-gray-500 mt-4 italic">
                    Note: The Simulated C14 Age is calculated for demonstration. It converts the calendar year to a "BP" (Before Present, 1950) value, adds a slight non-linear variation to mimic the calibration curve, and then applies a random measurement error based on the specified standard deviation.
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const runButton = document.getElementById('run-simulation-btn');
        const resultsContainer = document.getElementById('results-container');
        const resultsBody = document.getElementById('results-body');

        // --- Data Structure ---
        // We define our known archaeological data in an array of objects.
        const samples = [
            { phase: 1, name: "Monster_1", trueYearBC: 750, stdError: 30 },
            { phase: 2, name: "Monster_2", trueYearBC: 650, stdError: 30 },
            { phase: 2, name: "Monster_3", trueYearBC: 600, stdError: 30 },
            { phase: 3, name: "Monster_4", trueYearBC: 525, stdError: 30 }
        ];

        // --- Event Listener ---
        runButton.addEventListener('click', () => {
            runSimulation();
        });
        
        // --- Core Simulation Logic ---
        function runSimulation() {
            // Clear previous results and show the container
            resultsBody.innerHTML = '';
            resultsContainer.classList.remove('hidden');

            // Process each sample
            samples.forEach(sample => {
                const simulatedAge = generateSimulatedC14Age(sample.trueYearBC, sample.stdError);
                displayResult(sample, simulatedAge);
            });
        }
        
        /**
         * Generates a simulated C14 age (BP).
         * This is a simplified model for demonstration. A real model uses the IntCal20 curve.
         * @param {number} yearBC - The true calendar year in BC (e.g., 750).
         * @param {number} stdError - The standard error for the measurement.
         * @returns {string} A formatted string of the simulated C14 age, e.g., "2580 ± 30 BP".
         */
        function generateSimulatedC14Age(yearBC, stdError) {
            // 1. Convert BC year to a "Before Present" (1950) date.
            // Year 1 BC is -0, 750 BC is -749. So, BP = 1950 - (-yearBC + 1) = 1949 + yearBC
            const baseBP = 1949 + yearBC;

            // 2. Simulate non-linearity of the calibration curve (simplified).
            // We add a small, semi-random offset based on the year to mimic wiggles in the curve.
            const curveEffect = Math.sin(baseBP / 200) * 25; // Example wiggle
            const bpWithCurve = baseBP + curveEffect;

            // 3. Add random measurement error using a Normal (Gaussian) distribution.
            // We use the Box-Muller transform to generate a normally distributed random number.
            const u1 = Math.random();
            const u2 = Math.random();
            const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            const randomError = z0 * stdError;
            
            const finalBP = Math.round(bpWithCurve + randomError);

            return `${finalBP} ± ${stdError} BP`;
        }

        /**
         * Creates and appends a table row with the simulation result.
         * @param {object} sampleData - The original sample data.
         * @param {string} simulatedAge - The generated C14 age string.
         */
        function displayResult(sampleData, simulatedAge) {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50";
            
            row.innerHTML = `
                <td class="py-3 px-4 text-sm font-medium">${sampleData.phase}</td>
                <td class="py-3 px-4 text-sm">${sampleData.name}</td>
                <td class="py-3 px-4 text-sm">${sampleData.trueYearBC} BC</td>
                <td class="py-3 px-4 text-sm font-mono">${simulatedAge}</td>
            `;

            resultsBody.appendChild(row);
        }

    </script>
</body>
</html>
